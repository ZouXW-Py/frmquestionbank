<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRM題庫練習系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e6ef;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        /* 主目錄樣式 */
        .main-catalog-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .main-catalog-item {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            width: calc(25% - 20px);
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            text-align: center;
        }
        
        .main-catalog-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .main-catalog-item.selected {
            border: 2px solid #3498db;
            background-color: #f0f8ff;
        }
        
        .catalog-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .catalog-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .catalog-description {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        /* 錯題庫特殊樣式 */
        .main-catalog-item.wrong-questions {
            border-top: 4px solid #e74c3c;
        }
        
        .wrong-questions .catalog-icon {
            color: #e74c3c;
        }
        
        /* 子目錄樣式 */
        .sub-catalog-container {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .sub-catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .sub-catalog-title {
            font-size: 1.6rem;
            color: #2c3e50;
        }
        
        .back-to-main {
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .back-to-main:hover {
            background-color: #7f8c8d;
        }
        
        .subdirectory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .subdirectory-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        
        .subdirectory-item:hover {
            background-color: #e3f2fd;
            border-left-color: #3498db;
            transform: translateX(5px);
        }
        
        .subdirectory-name {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .question-count {
            font-size: 0.85rem;
            color: #95a5a6;
        }
        
        /* 錯題庫子目錄特殊樣式 */
        .wrong-question-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .wrong-count {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .mastery-count {
            color: #2ecc71;
            font-weight: 600;
        }
        
        /* 練習介面樣式 */
        .practice-container {
            display: none;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            background-color: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .stat-box {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        /* 錯題庫練習統計特殊樣式 */
        .wrong-questions-stats .stat-value {
            color: #e74c3c;
        }
        
        .question-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .question-number {
            font-size: 1.1rem;
            color: #3498db;
            font-weight: 600;
        }
        
        .module-info {
            font-size: 0.9rem;
            color: #95a5a6;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 25px;
            color: #2c3e50;
            line-height: 1.5;
        }
        
        /* 錯題標記 */
        .wrong-question-tag {
            background-color: #fdeaea;
            color: #e74c3c;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .correct-count-tag {
            background-color: #e8f7ef;
            color: #2ecc71;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .options-container {
            margin-bottom: 25px;
        }
        
        .option {
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #e0e6ef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            background-color: #f8f9fa;
            border-color: #bdc3c7;
        }
        
        .option.selected {
            border-color: #3498db;
            background-color: #ebf5fb;
        }
        
        .option.correct {
            border-color: #2ecc71;
            background-color: #d5f4e6;
        }
        
        .option.incorrect {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }
        
        .option-letter {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #ecf0f1;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .option-text {
            flex: 1;
        }
        
        .feedback-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            display: none;
        }
        
        .feedback-container.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .result-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .correct .result-icon {
            color: #2ecc71;
        }
        
        .incorrect .result-icon {
            color: #e74c3c;
        }
        
        .explanation-title {
            font-weight: 600;
            margin: 15px 0 10px;
            color: #2c3e50;
        }
        
        .explanation-text {
            color: #34495e;
            line-height: 1.6;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background-color: #bdc3c7;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .back-to-catalog {
            background-color: #95a5a6;
            color: white;
            margin-bottom: 20px;
        }
        
        .back-to-catalog:hover {
            background-color: #7f8c8d;
        }
        
        .current-selection {
            background-color: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
        }
        
        .selection-label {
            font-weight: 600;
            color: #7f8c8d;
            margin-right: 10px;
        }
        
        .selection-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .progress-container {
            margin-top: 30px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #95a5a6;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .main-catalog-item {
                width: calc(50% - 20px);
            }
            
            .stats-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
            
            .subdirectory-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>FRM題庫練習系統</h1>
        <p class="subtitle">選擇課程主題，針對性練習提升考試準備效率</p>
    </header>
    
    <!-- 主目錄介面 -->
    <div id="main-catalog-interface">
        <div class="main-catalog-container">
            <!-- 課程 A -->
            <div class="main-catalog-item" data-section="A">
                <div class="catalog-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="catalog-title">A. Foundations of Risk Management</div>
                <div class="catalog-description">風險管理基礎知識</div>
            </div>
            
            <!-- 課程 B -->
            <div class="main-catalog-item" data-section="B">
                <div class="catalog-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="catalog-title">B. Quantitative Analysis</div>
                <div class="catalog-description">定量分析與統計方法</div>
            </div>
            
            <!-- 課程 C -->
            <div class="main-catalog-item" data-section="C">
                <div class="catalog-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="catalog-title">C. Financial Markets and Products</div>
                <div class="catalog-description">金融市場與產品</div>
            </div>
            
            <!-- 課程 D -->
            <div class="main-catalog-item" data-section="D">
                <div class="catalog-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="catalog-title">D. Valuation and Risk Management</div>
                <div class="catalog-description">估值與風險管理</div>
            </div>
            
            <!-- 錯題庫 -->
            <div class="main-catalog-item wrong-questions" data-section="W">
                <div class="catalog-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="catalog-title">錯題庫</div>
                <div class="catalog-description">集中練習答錯的題目</div>
            </div>
        </div>
    </div>
    
    <!-- 子目錄介面 -->
    <div id="sub-catalog-interface" class="sub-catalog-container">
        <div class="sub-catalog-header">
            <h2 class="sub-catalog-title" id="sub-catalog-title">子目錄</h2>
            <button class="back-to-main" id="back-to-main-btn">
                <i class="fas fa-arrow-left"></i> 返回主目錄
            </button>
        </div>
        <div class="subdirectory-grid" id="subdirectory-grid">
            <!-- 子目錄將由JavaScript動態生成 -->
        </div>
    </div>
    
    <!-- 錯題庫子目錄介面 -->
    <div id="wrong-questions-catalog" class="sub-catalog-container">
        <div class="sub-catalog-header">
            <h2 class="sub-catalog-title">錯題庫</h2>
            <button class="back-to-main" id="back-to-main-wrong-btn">
                <i class="fas fa-arrow-left"></i> 返回主目錄
            </button>
        </div>
        <div class="subdirectory-grid" id="wrong-questions-grid">
            <!-- 錯題分類將由JavaScript動態生成 -->
        </div>
    </div>
    
    <!-- 練習介面 -->
    <div id="practice-interface" class="practice-container">
        <button class="btn back-to-catalog" id="back-to-catalog-btn">
            <i class="fas fa-arrow-left"></i> 返回目錄
        </button>
        
        <div class="current-selection">
            <span class="selection-label">當前練習主題：</span>
            <span class="selection-value" id="current-topic">未選擇</span>
        </div>
        
        <div class="stats-container" id="stats-container">
            <div class="stat-box">
                <div class="stat-value" id="current-question">1</div>
                <div class="stat-label">當前題目</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="total-questions">5</div>
                <div class="stat-label">總題數</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">答對題數</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">正確率</div>
            </div>
        </div>
        
        <!-- 錯題庫練習統計 -->
        <div class="stats-container wrong-questions-stats" id="wrong-questions-stats" style="display: none;">
            <div class="stat-box">
                <div class="stat-value" id="wrong-questions-count">0</div>
                <div class="stat-label">錯題數量</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="mastered-count">0</div>
                <div class="stat-label">已掌握題數</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="remaining-wrong-count">0</div>
                <div class="stat-label">待練習錯題</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="mastery-rate">0%</div>
                <div class="stat-label">掌握率</div>
            </div>
        </div>
        
        <div class="question-container">
            <div class="question-header">
                <div class="question-number" id="question-id">問題 #1</div>
                <div class="module-info" id="module-info">
                    Module 1.1, LO 1.a
                    <span class="wrong-question-tag" id="wrong-question-tag" style="display: none;">錯題</span>
                    <span class="correct-count-tag" id="correct-count-tag" style="display: none;">已答對 <span id="correct-count-value">0</span> 次</span>
                </div>
            </div>
            
            <div class="question-text" id="question-text">
                載入中...
            </div>
            
            <div class="options-container" id="options-container">
                <!-- 選項將由JavaScript動態生成 -->
            </div>
            
            <div class="feedback-container" id="feedback-container">
                <div id="result-message">
                    <!-- 結果訊息將由JavaScript動態生成 -->
                </div>
                <div class="explanation-title">說明：</div>
                <div class="explanation-text" id="explanation-text">
                    <!-- 說明文字將由JavaScript動態生成 -->
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-secondary" id="prev-btn" disabled>
                    <i class="fas fa-arrow-left"></i> 上一題
                </button>
                <button class="btn btn-primary" id="submit-btn">
                    提交答案
                </button>
                <button class="btn btn-primary" id="next-btn" style="display: none;">
                    下一題 <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span>進度</span>
                <span id="progress-text">0/5</span>
            </div>
        </div>
    </div>
    
    <footer>
        <p>FRM題庫練習系統 &copy; 2023 | 基於Kaplan FRM題庫內容</p>
    </footer>

    <script>
        // 目錄結構
        const catalog = {
            "A": {
                title: "Foundations of Risk Management",
                description: "風險管理基礎知識",
                subdirectories: [
                    { id: "A1", name: "The Building Blocks of Risk Management", questionCount: 7 },
                    { id: "A2", name: "How Do Firms Manage Financial Risk?", questionCount: 5 },
                    { id: "A3", name: "The Governance of Risk Management", questionCount: 5 },
                    { id: "A4", name: "Credit Risk Transfer Mechanisms", questionCount: 5 },
                    { id: "A5", name: "Modern Portfolio Theory (MPT) and the Capital Asset Pricing Model (CAPM)", questionCount: 71 },
                    { id: "A6", name: "The Arbitrage Pricing Theory and Multifactor Models of Risk and Return", questionCount: 9 },
                    { id: "A7", name: "Risk Data Aggregation and Reporting Principles", questionCount: 5 },
                    { id: "A8", name: "Enterprise Risk Management and Future Trends", questionCount: 5 },
                    { id: "A9", name: "Learning From Financial Disasters", questionCount: 7 },
                    { id: "A10", name: "Anatomy of the Great Financial Crisis of 2007-2009", questionCount: 5 },
                    { id: "A11", name: "GARP Code of Conduct", questionCount: 7 }
                ]
            },
            "B": {
                title: "Quantitative Analysis",
                description: "定量分析與統計方法",
                subdirectories: [
                    { id: "B1", name: "Fundamentals of Probability", questionCount: 21 },
                    { id: "B2", name: "Random Variables", questionCount: 10 },
                    { id: "B3", name: "Common Univariate Random Variables", questionCount: 31 },
                    { id: "B4", name: "Multivariate Random Variables", questionCount: 5 },
                    { id: "B5", name: "Sample Moments", questionCount: 55 },
                    { id: "B6", name: "Hypothesis Testing", questionCount: 60 },
                    { id: "B7", name: "Linear Regression", questionCount: 0 },
                    { id: "B8", name: "Regression with Multiple Explanatory Variables", questionCount: 0 },
                    { id: "B9", name: "Regression Diagnostics", questionCount: 0 },
                    { id: "B10", name: "Stationary Time Series", questionCount: 0 },
                    { id: "B11", name: "Nonstationary Time Series", questionCount: 0 },
                    { id: "B12", name: "Measuring Return, Volatility, and Correlation", questionCount: 0 },
                    { id: "B13", name: "Simulation and Bootstrapping", questionCount: 0 }
                ]
            },
            "C": {
                title: "Financial Markets and Products",
                description: "金融市場與產品",
                subdirectories: [
                    { id: "C1", name: "Banks", questionCount: 0 },
                    { id: "C2", name: "Insurance Companies and Pension Plans", questionCount: 0 },
                    { id: "C3", name: "Fund Management", questionCount: 0 },
                    { id: "C4", name: "Introduction to Derivatives", questionCount: 0 },
                    { id: "C5", name: "Exchanges and OTC Markets", questionCount: 0 },
                    { id: "C6", name: "Central Clearing", questionCount: 0 },
                    { id: "C7", name: "Futures Markets", questionCount: 0 },
                    { id: "C8", name: "Using Futures for Hedging", questionCount: 0 },
                    { id: "C9", name: "Foreign Exchange Markets", questionCount: 0 },
                    { id: "C10", name: "Pricing Financial Forwards and Futures", questionCount: 0 },
                    { id: "C11", name: "Commodity Forwards and Futures", questionCount: 0 },
                    { id: "C12", name: "Options Markets", questionCount: 0 },
                    { id: "C13", name: "Properties of Options", questionCount: 0 },
                    { id: "C14", name: "Trading Strategies", questionCount: 0 },
                    { id: "C15", name: "Exotic Options", questionCount: 0 },
                    { id: "C16", name: "Properties of Interest Rates", questionCount: 0 },
                    { id: "C17", name: "Corporate Bonds", questionCount: 0 },
                    { id: "C18", name: "Mortgages and Mortgage-backed Securities", questionCount: 0 },
                    { id: "C19", name: "Interest Rate Futures", questionCount: 0 },
                    { id: "C20", name: "SWAPS", questionCount: 0 }
                ]
            },
            "D": {
                title: "Valuation and Risk Management",
                description: "估值與風險管理",
                subdirectories: [
                    { id: "D1", name: "Measures of Financial Risk", questionCount: 0 },
                    { id: "D2", name: "Calculating and Applying VaR", questionCount: 0 },
                    { id: "D3", name: "Measuring and Monitoring Volatility", questionCount: 0 },
                    { id: "D4", name: "External and Internal Ratings", questionCount: 0 },
                    { id: "D5", name: "Country Risk", questionCount: 0 },
                    { id: "D6", name: "Measuring Credit Risk", questionCount: 0 },
                    { id: "D7", name: "Operational Risk", questionCount: 0 },
                    { id: "D8", name: "Stress-Testing", questionCount: 0 },
                    { id: "D9", name: "Pricing Conventions, Discounting, and Arbitrage", questionCount: 0 },
                    { id: "D10", name: "Interest Rates", questionCount: 0 },
                    { id: "D11", name: "Bond Yields and Return Calculations", questionCount: 0 },
                    { id: "D12", name: "Applying Duration, Convexity, and DV01", questionCount: 0 },
                    { id: "D13", name: "Modeling and Hedging Non-Parallel Term Structure Shifts", questionCount: 0 },
                    { id: "D14", name: "Binomial Trees", questionCount: 0 },
                    { id: "D15", name: "The Black-Scholes-Merton Model", questionCount: 0 },
                    { id: "D16", name: "Option Sensitivity Measures: The 'Greeks'", questionCount: 0 }
                ]
            },
            "W": {
                title: "錯題庫",
                description: "集中練習答錯的題目",
                subdirectories: []
            }
        };

        // 題庫數據 - 示例題目
        const questionBanks = {
            "A1": [
                {
                    id: 1,
                    text: "Unexpected volatility in an asset is often called:",
                    options: [
                        "biased expectations.",
                        "an upward earnings surprise.",
                        "asset price instability.",
                        "risk."
                    ],
                    correctAnswer: 3,
                    explanation: "Risk is described as unexpected volatility in asset prices or earnings.",
                    module: "Book 1, Module 1.1, LO 1.a"
                },
                {
                    id: 2,
                    text: "Value at risk (VaR) is the:",
                    options: [
                        "maximum expected loss for a given confidence level.",
                        "minimum expected loss for a given confidence level.",
                        "average loss exceeding a specified threshold.",
                        "the worst possible loss for an asset."
                    ],
                    correctAnswer: 0,
                    explanation: "VaR is the maximum expected loss for a given confidence level assuming normal market returns. It is the minimum expected loss for a given significance level.",
                    module: "Book 1, Module 1.1, LO 1.c"
                },
                {
                    id: 3,
                    text: "Funding liquidity risk refers to the risk:",
                    options: [
                        "that an institution will not be able to raise cash necessary to make debt payments.",
                        "resulting from a large position size in an asset relative to the asset's typical trading lot size.",
                        "that a counterparty to a financial transaction will default.",
                        "that the government will decide to terminate a government-funded program."
                    ],
                    correctAnswer: 0,
                    explanation: "Funding liquidity risk refers to the risk that an institution will not be able to raise cash necessary to make debt payments, fulfill cash, margin, and collateral requirements of counterparties, and meet capital withdrawals resulting in a loss.",
                    module: "Book 1, Module 1.2, LO 1.f"
                },
                {
                    id: 4,
                    text: "The risk that a counterparty will fail to deliver its obligation is:",
                    options: [
                        "model risk.",
                        "settlement risk.",
                        "delivery risk.",
                        "people risk."
                    ],
                    correctAnswer: 1,
                    explanation: "Settlement risk is the risk that a counterparty will fail to deliver its obligation.",
                    module: "Book 1, Module 1.2, LO 1.f"
                },
                {
                    id: 5,
                    text: "Which of the following liquidity definitions is most likely associated with market liquidity?",
                    options: [
                        "The risk that depositors will withdraw funds from banks, or that investors will redeem their shares.",
                        "The risk that investors may not be able to roll over short-term debt to finance the purchase of an asset.",
                        "The loss that would be sustained by a trader who sells an asset and then immediately buys it back.",
                        "The risk that arises when a decline in the collateral value of an asset results in an increase in margin requirement, requiring additional equity capital."
                    ],
                    correctAnswer: 2,
                    explanation: "Market liquidity can be expressed in the following forms: (1) bid-ask spread, (2) market depth, and (3) market resiliency. The bid-ask spread can be thought of as the loss that would be sustained by a trader who sells an asset and then immediately buys it back. The higher the spread, the lower the market liquidity, and vice versa. The other choices refer to funding liquidity.",
                    module: "Book 1, Module 1.2, LO 1.f"
                }
            ],
            "A2": [
                {
                    id: 1,
                    text: "When evaluating methods to hedge operational and financial risks, including pricing, foreign currency, and interest rate risk, which of the following risks primarily pertain to the income statement?",
                    options: [
                        "Both hedging operational risk and hedging financial position risk.",
                        "Hedging operational risk only.",
                        "Neither hedging operational risk nor hedging financial position risk.",
                        "Hedging financial position risk only."
                    ],
                    correctAnswer: 1,
                    explanation: "Hedging operational risk covers a firm's activities in production (costs) and sales (revenue), which is essentially the income statement. Financial position risk pertains to a firm's balance sheet.",
                    module: "Book 1, Module 2.2, LO 2.d"
                }
            ],
            "B1": [
                {
                    id: 1,
                    text: "Let A and B be two mutually exclusive events with P(A) = 0.40 and P(B) = 0.20. Therefore:",
                    options: [
                        "P(A and B) = 0.08.",
                        "P(B | A) = 0.20.",
                        "P(A and B) = 0.",
                        "P(A or B) = 0.52."
                    ],
                    correctAnswer: 2,
                    explanation: "If the two events are mutually exclusive, the probability of both ocurring is zero.",
                    module: "Book 2, Module 12.1, LO 12.b"
                }
            ]
        };

        // 錯題庫管理
        class WrongQuestionsManager {
            constructor() {
                this.wrongQuestionsKey = 'frm_wrong_questions';
                this.loadWrongQuestions();
            }
            
            // 載入錯題
            loadWrongQuestions() {
                const stored = localStorage.getItem(this.wrongQuestionsKey);
                this.wrongQuestions = stored ? JSON.parse(stored) : [];
            }
            
            // 保存錯題
            saveWrongQuestions() {
                localStorage.setItem(this.wrongQuestionsKey, JSON.stringify(this.wrongQuestions));
            }
            
            // 添加錯題
            addWrongQuestion(question, topicId, topicName) {
                // 檢查是否已經存在
                const existingIndex = this.wrongQuestions.findIndex(q => 
                    q.questionId === question.id && q.topicId === topicId
                );
                
                if (existingIndex === -1) {
                    // 新增錯題
                    const wrongQuestion = {
                        questionId: question.id,
                        topicId: topicId,
                        topicName: topicName,
                        questionText: question.text,
                        options: [...question.options],
                        correctAnswer: question.correctAnswer,
                        explanation: question.explanation,
                        module: question.module,
                        wrongCount: 1,
                        correctCount: 0, // 連續答對次數
                        lastAnswered: new Date().toISOString(),
                        addedDate: new Date().toISOString()
                    };
                    
                    this.wrongQuestions.push(wrongQuestion);
                    this.saveWrongQuestions();
                    return true;
                } else {
                    // 已經存在，增加錯誤次數
                    this.wrongQuestions[existingIndex].wrongCount++;
                    this.wrongQuestions[existingIndex].correctCount = 0; // 重置連續答對次數
                    this.wrongQuestions[existingIndex].lastAnswered = new Date().toISOString();
                    this.saveWrongQuestions();
                    return false;
                }
            }
            
            // 更新答對次數
            updateCorrectCount(questionId, topicId, isCorrect) {
                const questionIndex = this.wrongQuestions.findIndex(q => 
                    q.questionId === questionId && q.topicId === topicId
                );
                
                if (questionIndex !== -1) {
                    if (isCorrect) {
                        this.wrongQuestions[questionIndex].correctCount++;
                        this.wrongQuestions[questionIndex].lastAnswered = new Date().toISOString();
                        
                        // 如果連續答對3次，從錯題庫移除
                        if (this.wrongQuestions[questionIndex].correctCount >= 3) {
                            this.wrongQuestions.splice(questionIndex, 1);
                            this.saveWrongQuestions();
                            return 'removed';
                        }
                    } else {
                        // 答錯，重置連續答對次數
                        this.wrongQuestions[questionIndex].correctCount = 0;
                        this.wrongQuestions[questionIndex].wrongCount++;
                        this.wrongQuestions[questionIndex].lastAnswered = new Date().toISOString();
                    }
                    
                    this.saveWrongQuestions();
                    return 'updated';
                }
                
                return 'not_found';
            }
            
            // 獲取錯題列表（按主題分類）
            getWrongQuestionsByTopic() {
                const topics = {};
                
                this.wrongQuestions.forEach(question => {
                    if (!topics[question.topicId]) {
                        topics[question.topicId] = {
                            topicId: question.topicId,
                            topicName: question.topicName,
                            questions: [],
                            count: 0,
                            mastered: 0
                        };
                    }
                    
                    topics[question.topicId].questions.push(question);
                    topics[question.topicId].count++;
                    
                    if (question.correctCount >= 2) {
                        topics[question.topicId].mastered++;
                    }
                });
                
                return Object.values(topics);
            }
            
            // 獲取所有錯題
            getAllWrongQuestions() {
                return this.wrongQuestions;
            }
            
            // 獲取錯題數量
            getWrongQuestionCount() {
                return this.wrongQuestions.length;
            }
            
            // 獲取已掌握題數（連續答對2次或以上）
            getMasteredCount() {
                return this.wrongQuestions.filter(q => q.correctCount >= 2).length;
            }
            
            // 檢查題目是否在錯題庫中
            isWrongQuestion(questionId, topicId) {
                return this.wrongQuestions.some(q => 
                    q.questionId === questionId && q.topicId === topicId
                );
            }
            
            // 獲取錯題的連續答對次數
            getCorrectCount(questionId, topicId) {
                const question = this.wrongQuestions.find(q => 
                    q.questionId === questionId && q.topicId === topicId
                );
                
                return question ? question.correctCount : 0;
            }
            
            // 清空錯題庫
            clearWrongQuestions() {
                this.wrongQuestions = [];
                this.saveWrongQuestions();
            }
            
            // 移除特定錯題
            removeWrongQuestion(questionId, topicId) {
                const initialLength = this.wrongQuestions.length;
                this.wrongQuestions = this.wrongQuestions.filter(q => 
                    !(q.questionId === questionId && q.topicId === topicId)
                );
                
                if (this.wrongQuestions.length < initialLength) {
                    this.saveWrongQuestions();
                    return true;
                }
                
                return false;
            }
        }

        // 應用狀態
        let currentQuestionIndex = 0;
        let selectedOptionIndex = null;
        let isSubmitted = false;
        let correctCount = 0;
        let userAnswers = [];
        let currentTopic = null;
        let currentQuestions = [];
        let currentSection = null;
        let isWrongQuestionsMode = false;
        
        // 初始化錯題管理器
        const wrongQuestionsManager = new WrongQuestionsManager();
        
        // DOM元素
        const mainCatalogInterface = document.getElementById('main-catalog-interface');
        const subCatalogInterface = document.getElementById('sub-catalog-interface');
        const wrongQuestionsCatalog = document.getElementById('wrong-questions-catalog');
        const practiceInterface = document.getElementById('practice-interface');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const backToMainWrongBtn = document.getElementById('back-to-main-wrong-btn');
        const backToCatalogBtn = document.getElementById('back-to-catalog-btn');
        const subCatalogTitle = document.getElementById('sub-catalog-title');
        const subdirectoryGrid = document.getElementById('subdirectory-grid');
        const wrongQuestionsGrid = document.getElementById('wrong-questions-grid');
        const currentTopicElement = document.getElementById('current-topic');
        
        // 練習介面元素
        const questionTextElement = document.getElementById('question-text');
        const optionsContainerElement = document.getElementById('options-container');
        const feedbackContainerElement = document.getElementById('feedback-container');
        const resultMessageElement = document.getElementById('result-message');
        const explanationTextElement = document.getElementById('explanation-text');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const currentQuestionElement = document.getElementById('current-question');
        const totalQuestionsElement = document.getElementById('total-questions');
        const correctCountElement = document.getElementById('correct-count');
        const accuracyElement = document.getElementById('accuracy');
        const progressFillElement = document.getElementById('progress-fill');
        const progressTextElement = document.getElementById('progress-text');
        const questionIdElement = document.getElementById('question-id');
        const moduleInfoElement = document.getElementById('module-info');
        const wrongQuestionTag = document.getElementById('wrong-question-tag');
        const correctCountTag = document.getElementById('correct-count-tag');
        const correctCountValue = document.getElementById('correct-count-value');
        
        // 錯題庫統計元素
        const statsContainer = document.getElementById('stats-container');
        const wrongQuestionsStats = document.getElementById('wrong-questions-stats');
        const wrongQuestionsCountElement = document.getElementById('wrong-questions-count');
        const masteredCountElement = document.getElementById('mastered-count');
        const remainingWrongCountElement = document.getElementById('remaining-wrong-count');
        const masteryRateElement = document.getElementById('mastery-rate');
        
        // 初始化
        function init() {
            // 為每個主目錄項目添加點擊事件
            document.querySelectorAll('.main-catalog-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    if (section === 'W') {
                        openWrongQuestionsCatalog();
                    } else {
                        selectMainCatalog(section);
                    }
                });
            });
            
            // 為返回按鈕添加事件
            backToMainBtn.addEventListener('click', backToMainCatalog);
            backToMainWrongBtn.addEventListener('click', backToMainCatalog);
            backToCatalogBtn.addEventListener('click', backToCatalog);
            
            // 初始化練習介面事件
            submitBtn.addEventListener('click', submitAnswer);
            nextBtn.addEventListener('click', nextQuestion);
            prevBtn.addEventListener('click', prevQuestion);
            
            // 初始化錯題庫目錄
            initWrongQuestionsCatalog();
        }
        
        // 初始化錯題庫目錄
        function initWrongQuestionsCatalog() {
            updateWrongQuestionsCatalog();
        }
        
        // 更新錯題庫目錄
        function updateWrongQuestionsCatalog() {
            const wrongQuestionsByTopic = wrongQuestionsManager.getWrongQuestionsByTopic();
            
            // 清空錯題庫網格
            wrongQuestionsGrid.innerHTML = '';
            
            if (wrongQuestionsByTopic.length === 0) {
                wrongQuestionsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #95a5a6;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 20px; color: #2ecc71;"></i>
                        <h3 style="margin-bottom: 10px;">暫無錯題</h3>
                        <p>目前沒有答錯的題目，繼續保持！</p>
                    </div>
                `;
                return;
            }
            
            // 添加錯題分類
            wrongQuestionsByTopic.forEach(topic => {
                const topicItem = document.createElement('div');
                topicItem.className = 'subdirectory-item';
                topicItem.dataset.topicId = topic.topicId;
                
                topicItem.innerHTML = `
                    <div class="subdirectory-name">${topic.topicName}</div>
                    <div class="wrong-question-stats">
                        <div class="wrong-count">${topic.count} 題錯題</div>
                        <div class="mastery-count">${topic.mastered} 題已掌握</div>
                    </div>
                `;
                
                // 添加點擊事件
                topicItem.addEventListener('click', () => selectWrongQuestionsTopic(topic.topicId));
                
                wrongQuestionsGrid.appendChild(topicItem);
            });
            
            // 添加「所有錯題」選項
            const allWrongQuestionsItem = document.createElement('div');
            allWrongQuestionsItem.className = 'subdirectory-item';
            allWrongQuestionsItem.style.borderLeft = '4px solid #e74c3c';
            
            const totalWrongQuestions = wrongQuestionsManager.getWrongQuestionCount();
            const totalMastered = wrongQuestionsManager.getMasteredCount();
            
            allWrongQuestionsItem.innerHTML = `
                <div class="subdirectory-name">所有錯題</div>
                <div class="wrong-question-stats">
                    <div class="wrong-count">${totalWrongQuestions} 題錯題</div>
                    <div class="mastery-count">${totalMastered} 題已掌握</div>
                </div>
            `;
            
            allWrongQuestionsItem.addEventListener('click', () => selectAllWrongQuestions());
            wrongQuestionsGrid.appendChild(allWrongQuestionsItem);
        }
        
        // 打開錯題庫目錄
        function openWrongQuestionsCatalog() {
            updateWrongQuestionsCatalog();
            mainCatalogInterface.style.display = 'none';
            wrongQuestionsCatalog.style.display = 'block';
        }
        
        // 選擇錯題庫主題
        function selectWrongQuestionsTopic(topicId) {
            const wrongQuestionsByTopic = wrongQuestionsManager.getWrongQuestionsByTopic();
            const topic = wrongQuestionsByTopic.find(t => t.topicId === topicId);
            
            if (!topic || topic.questions.length === 0) {
                alert('此主題暫無錯題');
                return;
            }
            
            // 設置為錯題庫模式
            isWrongQuestionsMode = true;
            currentTopic = topicId;
            currentQuestions = topic.questions.map(q => ({
                id: q.questionId,
                text: q.questionText,
                options: q.options,
                correctAnswer: q.correctAnswer,
                explanation: q.explanation,
                module: q.module,
                isWrongQuestion: true,
                wrongQuestionData: q
            }));
            
            // 更新當前主題顯示
            currentTopicElement.textContent = `錯題庫 - ${topic.topicName}`;
            
            // 重置練習狀態
            resetPracticeState();
            
            // 切換到練習介面
            wrongQuestionsCatalog.style.display = 'none';
            practiceInterface.style.display = 'block';
            
            // 顯示錯題庫統計
            statsContainer.style.display = 'none';
            wrongQuestionsStats.style.display = 'flex';
            updateWrongQuestionsStats();
            
            // 載入第一題
            loadQuestion(currentQuestionIndex);
            updateStats();
            updateProgress();
        }
        
        // 選擇所有錯題
        function selectAllWrongQuestions() {
            const allWrongQuestions = wrongQuestionsManager.getAllWrongQuestions();
            
            if (allWrongQuestions.length === 0) {
                alert('暫無錯題');
                return;
            }
            
            // 設置為錯題庫模式
            isWrongQuestionsMode = true;
            currentTopic = 'W_ALL';
            currentQuestions = allWrongQuestions.map(q => ({
                id: q.questionId,
                text: q.questionText,
                options: q.options,
                correctAnswer: q.correctAnswer,
                explanation: q.explanation,
                module: q.module,
                isWrongQuestion: true,
                wrongQuestionData: q
            }));
            
            // 更新當前主題顯示
            currentTopicElement.textContent = `錯題庫 - 所有錯題`;
            
            // 重置練習狀態
            resetPracticeState();
            
            // 切換到練習介面
            wrongQuestionsCatalog.style.display = 'none';
            practiceInterface.style.display = 'block';
            
            // 顯示錯題庫統計
            statsContainer.style.display = 'none';
            wrongQuestionsStats.style.display = 'flex';
            updateWrongQuestionsStats();
            
            // 載入第一題
            loadQuestion(currentQuestionIndex);
            updateStats();
            updateProgress();
        }
        
        // 更新錯題庫統計
        function updateWrongQuestionsStats() {
            const totalWrongQuestions = wrongQuestionsManager.getWrongQuestionCount();
            const masteredCount = wrongQuestionsManager.getMasteredCount();
            const remainingCount = totalWrongQuestions - masteredCount;
            const masteryRate = totalWrongQuestions > 0 ? Math.round((masteredCount / totalWrongQuestions) * 100) : 0;
            
            wrongQuestionsCountElement.textContent = totalWrongQuestions;
            masteredCountElement.textContent = masteredCount;
            remainingWrongCountElement.textContent = remainingCount;
            masteryRateElement.textContent = `${masteryRate}%`;
        }
        
        // 選擇主目錄
        function selectMainCatalog(sectionKey) {
            currentSection = sectionKey;
            const section = catalog[sectionKey];
            
            // 更新子目錄標題
            subCatalogTitle.textContent = `${sectionKey}. ${section.title}`;
            
            // 清空子目錄網格
            subdirectoryGrid.innerHTML = '';
            
            // 添加子目錄項目
            section.subdirectories.forEach(subdirectory => {
                const subdirectoryItem = document.createElement('div');
                subdirectoryItem.className = 'subdirectory-item';
                subdirectoryItem.dataset.id = subdirectory.id;
                
                subdirectoryItem.innerHTML = `
                    <div class="subdirectory-name">${subdirectory.name}</div>
                    <div class="question-count">${subdirectory.questionCount > 0 ? `${subdirectory.questionCount} 題` : '暫無題目'}</div>
                `;
                
                // 添加點擊事件
                subdirectoryItem.addEventListener('click', () => selectSubdirectory(subdirectory.id));
                
                subdirectoryGrid.appendChild(subdirectoryItem);
            });
            
            // 切換到子目錄介面
            mainCatalogInterface.style.display = 'none';
            subCatalogInterface.style.display = 'block';
        }
        
        // 選擇子目錄
        function selectSubdirectory(subdirectoryId) {
            isWrongQuestionsMode = false;
            currentTopic = subdirectoryId;
            
            // 載入對應題庫
            currentQuestions = questionBanks[subdirectoryId] || [];
            
            if (currentQuestions.length === 0) {
                alert('此主題暫無題目，請選擇其他主題');
                return;
            }
            
            // 更新當前主題顯示
            const sectionKey = subdirectoryId.charAt(0);
            const section = catalog[sectionKey];
            const subdirectory = section.subdirectories.find(s => s.id === subdirectoryId);
            
            if (subdirectory) {
                currentTopicElement.textContent = `${sectionKey}. ${section.title} - ${subdirectory.name}`;
            }
            
            // 重置練習狀態
            resetPracticeState();
            
            // 切換到練習介面
            subCatalogInterface.style.display = 'none';
            practiceInterface.style.display = 'block';
            
            // 顯示普通統計
            statsContainer.style.display = 'flex';
            wrongQuestionsStats.style.display = 'none';
            
            // 載入第一題
            loadQuestion(currentQuestionIndex);
            updateStats();
            updateProgress();
        }
        
        // 返回主目錄
        function backToMainCatalog() {
            subCatalogInterface.style.display = 'none';
            wrongQuestionsCatalog.style.display = 'none';
            mainCatalogInterface.style.display = 'block';
        }
        
        // 返回目錄（從練習介面）
        function backToCatalog() {
            practiceInterface.style.display = 'none';
            
            if (isWrongQuestionsMode) {
                updateWrongQuestionsCatalog();
                wrongQuestionsCatalog.style.display = 'block';
            } else {
                mainCatalogInterface.style.display = 'block';
            }
        }
        
        // 重置練習狀態
        function resetPracticeState() {
            currentQuestionIndex = 0;
            selectedOptionIndex = null;
            isSubmitted = false;
            correctCount = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
        }
        
        // 載入問題
        function loadQuestion(index) {
            const question = currentQuestions[index];
            
            // 重置狀態
            selectedOptionIndex = userAnswers[index];
            isSubmitted = userAnswers[index] !== null;
            
            // 更新問題資訊
            questionTextElement.textContent = question.text;
            questionIdElement.textContent = `問題 #${question.id}`;
            moduleInfoElement.textContent = question.module;
            currentQuestionElement.textContent = index + 1;
            totalQuestionsElement.textContent = currentQuestions.length;
            
            // 更新錯題標記
            if (question.isWrongQuestion) {
                wrongQuestionTag.style.display = 'inline-block';
                const correctCount = question.wrongQuestionData ? question.wrongQuestionData.correctCount : 0;
                correctCountValue.textContent = correctCount;
                correctCountTag.style.display = 'inline-block';
            } else {
                wrongQuestionTag.style.display = 'none';
                correctCountTag.style.display = 'none';
            }
            
            // 清空選項容器
            optionsContainerElement.innerHTML = '';
            
            // 創建選項
            question.options.forEach((option, optionIndex) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                
                // 如果已提交答案，顯示正確/錯誤樣式
                if (isSubmitted) {
                    if (optionIndex === question.correctAnswer) {
                        optionElement.classList.add('correct');
                    } else if (optionIndex === selectedOptionIndex && optionIndex !== question.correctAnswer) {
                        optionElement.classList.add('incorrect');
                    }
                }
                
                // 如果當前選項被選中，添加selected類
                if (optionIndex === selectedOptionIndex) {
                    optionElement.classList.add('selected');
                }
                
                optionElement.innerHTML = `
                    <div class="option-letter">${String.fromCharCode(65 + optionIndex)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                // 如果未提交，添加點擊事件
                if (!isSubmitted) {
                    optionElement.addEventListener('click', () => selectOption(optionIndex));
                }
                
                optionsContainerElement.appendChild(optionElement);
            });
            
            // 更新按鈕狀態
            updateButtonState();
            
            // 顯示或隱藏反饋
            if (isSubmitted) {
                showFeedback(question);
            } else {
                feedbackContainerElement.classList.remove('show');
            }
        }
        
        // 選擇選項
        function selectOption(optionIndex) {
            if (isSubmitted) return;
            
            // 移除之前選中的選項的selected類
            const previouslySelected = document.querySelector('.option.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }
            
            // 為當前選中的選項添加selected類
            selectedOptionIndex = optionIndex;
            const options = document.querySelectorAll('.option');
            options[optionIndex].classList.add('selected');
            
            // 啟用提交按鈕
            submitBtn.disabled = false;
        }
        
        // 提交答案
        function submitAnswer() {
            if (selectedOptionIndex === null || isSubmitted) return;
            
            const question = currentQuestions[currentQuestionIndex];
            isSubmitted = true;
            userAnswers[currentQuestionIndex] = selectedOptionIndex;
            
            // 檢查答案是否正確
            const isCorrect = selectedOptionIndex === question.correctAnswer;
            
            if (isCorrect) {
                correctCount++;
                
                // 如果在錯題庫模式中，更新連續答對次數
                if (isWrongQuestionsMode && question.isWrongQuestion) {
                    const result = wrongQuestionsManager.updateCorrectCount(
                        question.id,
                        question.wrongQuestionData.topicId,
                        true
                    );
                    
                    if (result === 'removed') {
                        // 從當前問題列表中移除
                        currentQuestions.splice(currentQuestionIndex, 1);
                        userAnswers.splice(currentQuestionIndex, 1);
                        
                        // 如果沒有問題了，返回錯題庫
                        if (currentQuestions.length === 0) {
                            alert('恭喜！你已經掌握了所有錯題！');
                            backToCatalog();
                            return;
                        }
                        
                        // 調整當前問題索引
                        if (currentQuestionIndex >= currentQuestions.length) {
                            currentQuestionIndex = currentQuestions.length - 1;
                        }
                    }
                    
                    // 更新錯題庫統計
                    updateWrongQuestionsStats();
                }
            } else {
                // 答錯題目，如果不在錯題庫模式，則添加到錯題庫
                if (!isWrongQuestionsMode) {
                    const sectionKey = currentTopic.charAt(0);
                    const section = catalog[sectionKey];
                    const subdirectory = section.subdirectories.find(s => s.id === currentTopic);
                    
                    if (subdirectory) {
                        wrongQuestionsManager.addWrongQuestion(
                            question,
                            currentTopic,
                            `${sectionKey}. ${section.title} - ${subdirectory.name}`
                        );
                    }
                } else if (question.isWrongQuestion) {
                    // 在錯題庫模式中答錯，重置連續答對次數
                    wrongQuestionsManager.updateCorrectCount(
                        question.id,
                        question.wrongQuestionData.topicId,
                        false
                    );
                    
                    // 更新錯題庫統計
                    updateWrongQuestionsStats();
                }
            }
            
            // 顯示反饋
            showFeedback(question);
            
            // 更新統計數據
            updateStats();
            
            // 更新按鈕狀態
            updateButtonState();
        }
        
        // 顯示反饋
        function showFeedback(question) {
            const isCorrect = selectedOptionIndex === question.correctAnswer;
            
            // 設置結果訊息
            if (isCorrect) {
                resultMessageElement.innerHTML = `<span class="result-icon correct"><i class="fas fa-check-circle"></i></span> 正確！你的答案「${String.fromCharCode(65 + selectedOptionIndex)}」是正確的。`;
                
                // 如果在錯題庫模式，顯示連續答對次數
                if (isWrongQuestionsMode && question.isWrongQuestion) {
                    const correctCount = question.wrongQuestionData ? question.wrongQuestionData.correctCount : 0;
                    const remaining = 3 - correctCount;
                    
                    if (remaining > 0) {
                        resultMessageElement.innerHTML += `<br><small>再答對 ${remaining} 次即可從錯題庫移除</small>`;
                    } else {
                        resultMessageElement.innerHTML += `<br><small>已掌握此題！將從錯題庫移除</small>`;
                    }
                }
            } else {
                resultMessageElement.innerHTML = `<span class="result-icon incorrect"><i class="fas fa-times-circle"></i></span> 不正確。正確答案是「${String.fromCharCode(65 + question.correctAnswer)}」。`;
            }
            
            // 設置說明文字
            explanationTextElement.textContent = question.explanation;
            
            // 顯示反饋容器
            feedbackContainerElement.classList.add('show');
            
            // 禁用所有選項的點擊
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.style.cursor = 'default';
            });
        }
        
        // 下一題
        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
                updateProgress();
            }
        }
        
        // 上一題
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
                updateProgress();
            }
        }
        
        // 更新按鈕狀態
        function updateButtonState() {
            // 上一題按鈕
            prevBtn.disabled = currentQuestionIndex === 0;
            
            // 提交按鈕
            if (isSubmitted) {
                submitBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
            } else {
                submitBtn.style.display = 'inline-block';
                submitBtn.disabled = selectedOptionIndex === null;
                nextBtn.style.display = 'none';
            }
            
            // 下一題按鈕
            nextBtn.disabled = currentQuestionIndex === currentQuestions.length - 1 || !isSubmitted;
        }
        
        // 更新統計數據
        function updateStats() {
            correctCountElement.textContent = correctCount;
            const accuracy = currentQuestions.length > 0 ? Math.round((correctCount / currentQuestions.length) * 100) : 0;
            accuracyElement.textContent = `${accuracy}%`;
        }
        
        // 更新進度條
        function updateProgress() {
            const progressPercentage = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            progressFillElement.style.width = `${progressPercentage}%`;
            progressTextElement.textContent = `${currentQuestionIndex + 1}/${currentQuestions.length}`;
        }
        
        // 初始化應用
        init();
    </script>
</body>
</html>

